# @zapjs/router

The `@zapjs/router` package provides file-based routing using TanStack Router-style conventions. It automatically discovers routes from your filesystem and generates type-safe route manifests.

## Installation

```bash
npm install @zapjs/router
# or
bun add @zapjs/router
```

## Route Conventions

### File Patterns

| Pattern | Example File | URL Path |
|---------|--------------|----------|
| `index.tsx` | `routes/index.tsx` | `/` |
| `name.tsx` | `routes/about.tsx` | `/about` |
| `$param.tsx` | `routes/$postId.tsx` | `/:postId` |
| `name.$param.tsx` | `routes/users.$id.tsx` | `/users/:id` |
| `_layout.tsx` | `routes/_layout.tsx` | (layout wrapper) |
| `__root.tsx` | `routes/__root.tsx` | (root layout) |
| `(group)/` | `routes/(admin)/` | (no URL segment) |
| `-excluded/` | `routes/-utils/` | (excluded) |
| `api/*.ts` | `routes/api/hello.ts` | `/api/hello` |

### Directory Structure Example

```
routes/
├── __root.tsx           # Root layout
├── index.tsx            # /
├── about.tsx            # /about
├── $postId.tsx          # /:postId
├── users/
│   ├── index.tsx        # /users
│   └── $id.tsx          # /users/:id
├── (admin)/             # Route group
│   ├── dashboard.tsx    # /dashboard
│   └── settings.tsx     # /settings
├── -utils/              # Excluded
│   └── helpers.ts
└── api/                 # API routes
    ├── hello.ts         # /api/hello
    ├── users.ts         # /api/users
    └── users.$id.ts     # /api/users/:id
```

## RouteScanner

Scans a directory for route files and builds a route tree.

### Usage

```typescript
import { RouteScanner } from '@zapjs/router';

const scanner = new RouteScanner({
  routesDir: './routes',
  extensions: ['.tsx', '.ts'],
  apiDir: 'api',
});

const routes = await scanner.scan();

for (const route of routes) {
  console.log(`${route.urlPath} -> ${route.filePath}`);
}
```

### Options

```typescript
interface ScanOptions {
  // Directory containing route files
  routesDir: string;

  // File extensions to include
  extensions?: string[];  // Default: ['.tsx', '.ts', '.jsx', '.js']

  // Subdirectory for API routes
  apiDir?: string;  // Default: 'api'

  // Patterns to exclude
  exclude?: string[];  // Default: ['node_modules', '.git']
}
```

### ScannedRoute

```typescript
interface ScannedRoute {
  // Absolute file path
  filePath: string;

  // Path relative to routes dir
  relativePath: string;

  // Generated URL path
  urlPath: string;

  // Route type
  type: 'page' | 'api' | 'layout' | 'root';

  // Extracted parameters
  params: RouteParam[];

  // HTTP methods (API routes only)
  methods?: HttpMethod[];

  // Parent layout path
  layoutPath?: string;

  // Route group name
  group?: string;

  // Whether this is an index route
  isIndex: boolean;
}

interface RouteParam {
  name: string;
  type: 'static' | 'dynamic' | 'wildcard' | 'catchall';
}
```

## Code Generation

### generateRouteTree

Generates TypeScript files from scanned routes.

```typescript
import { generateRouteTree } from '@zapjs/router';

await generateRouteTree({
  routesDir: './routes',
  outputDir: './src/generated',
  typescript: true,
});
```

### Options

```typescript
interface CodegenOptions {
  // Routes directory
  routesDir: string;

  // Output directory
  outputDir: string;

  // Generate TypeScript (vs JavaScript)
  typescript?: boolean;

  // Generate route manifest JSON
  manifest?: boolean;

  // Generate Rust manifest
  rustManifest?: boolean;
}
```

### Generated Files

**routeTree.ts**
```typescript
// Auto-generated by @zapjs/router

export const routeTree = {
  '/': {
    filePath: 'routes/index.tsx',
    type: 'page',
    params: [],
  },
  '/users/:id': {
    filePath: 'routes/users.$id.tsx',
    type: 'page',
    params: [{ name: 'id', type: 'dynamic' }],
  },
  // ...
} as const;

export type RouteTree = typeof routeTree;
export type RoutePath = keyof RouteTree;
```

**routeManifest.json**
```json
{
  "version": "1.0.0",
  "generatedAt": "2024-01-01T00:00:00.000Z",
  "routes": [
    {
      "filePath": "routes/index.tsx",
      "urlPath": "/",
      "type": "page",
      "params": []
    }
  ],
  "apiRoutes": [
    {
      "filePath": "routes/api/users.$id.ts",
      "urlPath": "/api/users/:id",
      "type": "api",
      "params": [{ "name": "id", "type": "dynamic" }],
      "methods": ["GET", "PUT", "DELETE"]
    }
  ]
}
```

## Watch Mode

### RouteWatcher

Watches for route file changes and triggers regeneration.

```typescript
import { RouteWatcher } from '@zapjs/router';

const watcher = new RouteWatcher({
  routesDir: './routes',
  outputDir: './src/generated',
  onUpdate: (routes) => {
    console.log('Routes updated:', routes.length);
  },
  onError: (error) => {
    console.error('Watch error:', error);
  },
});

// Start watching
await watcher.start();

// Stop watching
await watcher.stop();
```

### watchAndRegenerate

Convenience function for watch mode.

```typescript
import { watchAndRegenerate } from '@zapjs/router';

await watchAndRegenerate({
  routesDir: './routes',
  outputDir: './src/generated',
  onUpdate: (routes) => {
    console.log('Regenerated', routes.length, 'routes');
  },
});
```

## Helper Functions

### flattenRoutes

Converts a route tree to a flat array.

```typescript
import { flattenRoutes } from '@zapjs/router';

const tree = await scanner.scan();
const flat = flattenRoutes(tree);
```

### findParentLayout

Finds the layout route for a given route.

```typescript
import { findParentLayout } from '@zapjs/router';

const layout = findParentLayout(route, allRoutes);
if (layout) {
  console.log('Layout:', layout.filePath);
}
```

### generateRustManifest

Creates a manifest for the Rust server.

```typescript
import { generateRustManifest } from '@zapjs/router';

const manifest = generateRustManifest(routes);
// Returns RouteManifest for Rust consumption
```

## API Route Handlers

API routes export HTTP method handlers.

### Example: routes/api/users.$id.ts

```typescript
import type { ZapRequest } from '@zapjs/runtime';

// GET /api/users/:id
export const GET = async (req: ZapRequest) => {
  const { id } = req.params;

  return {
    id,
    name: `User ${id}`,
    email: `user${id}@example.com`,
  };
};

// PUT /api/users/:id
export const PUT = async (req: ZapRequest) => {
  const { id } = req.params;
  const body = JSON.parse(req.body);

  return {
    id,
    ...body,
    updated: true,
  };
};

// DELETE /api/users/:id
export const DELETE = async (req: ZapRequest) => {
  const { id } = req.params;

  return {
    deleted: id,
  };
};
```

### Supported Methods

- `GET`
- `POST`
- `PUT`
- `DELETE`
- `PATCH`
- `HEAD`
- `OPTIONS`

### Response Formats

```typescript
// Object (auto-serialized to JSON)
export const GET = async () => ({ message: 'Hello' });

// With status and headers
export const POST = async () => ({
  status: 201,
  headers: { 'X-Custom': 'value' },
  body: { created: true },
});

// String
export const GET = async () => 'Plain text';
```

## Complete Example

### Project Structure

```
my-app/
├── routes/
│   ├── __root.tsx
│   ├── index.tsx
│   ├── about.tsx
│   └── api/
│       ├── hello.ts
│       └── users.$id.ts
├── src/
│   ├── generated/
│   │   ├── routeTree.ts
│   │   └── routeManifest.json
│   └── main.tsx
└── package.json
```

### Setup Script

```typescript
// scripts/generate-routes.ts
import { generateRouteTree } from '@zapjs/router';

async function main() {
  await generateRouteTree({
    routesDir: './routes',
    outputDir: './src/generated',
    typescript: true,
    manifest: true,
  });

  console.log('Routes generated!');
}

main();
```

### Using in Zap

```typescript
// src/server.ts
import { Zap } from '@zapjs/runtime';

const app = new Zap()
  .setPort(3000)
  .useFileRouting({
    routesDir: './routes',
    generatedDir: './src/generated',
  });

await app.listen();
```

---

## See Also

- [File Routing Guide](../guides/file-routing.md) - Detailed routing patterns
- [API Routes Guide](../guides/api-routes.md) - API handler patterns
- [Runtime API](./runtime.md) - Core runtime
